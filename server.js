var hostname = process.argv[2] || "0.0.0.0";
var port = parseInt(process.argv[3]) || 80;

var finalhandler = require('finalhandler');
var http = require('http');
var serveStatic = require('serve-static');

// Serve up public/ftp folder
var serve = serveStatic('public_html/', {'setHeaders': setHeaders});

function setHeaders(res, path) {
  res.setHeader('Cache-Control', 'public, max-age=0');
}

// Create server
var server = http.createServer(function onRequest (req, res) {
  serve(req, res, finalhandler(req, res));
});

// Listen
server.listen(port, hostname);

var validPrograms = {test: "/bin/sh"};
var spawn = require('child_process').spawn;

server = http.createServer();
var io = require('socket.io')(server);
io.on('connection', (socket) => {
  var proc;
  socket.on('start', (starting) => {
    if (proc) {
      socket.emit('stderr', 'bin-wrapper: Already running another program.');
      return;
    }
    
    if (!validPrograms[starting]) {
      socket.emit('stderr', 'bin-wrapper: ' + starting + ': command not found.');
      return;
    }
    
    proc = spawn(validPrograms[starting]);
    proc.on('exit', () => {
      proc = undefined;
      socket.disconnect()
    });
    proc.stdout.on('data', (data) => {
      socket.emit('stdout', data.toString());
    });
    proc.stderr.on('data', (data) => {
      socket.emit('stderr', data.toString());
    });
  });
  
  socket.on('interrupt', () => {
    proc.kill('SIGINT');
  })
  
  socket.on('end', () => {
    proc.stdin.end();
  });
  
  socket.on('disconnect', () => {
    if (proc) {
      proc.kill('SIGKILL');
      proc = undefined;
    }
  });
  
  socket.on('stdin', (data) => {
    if (typeof data !== 'string') {
      socket.emit('stderr', 'bin-wrapper: Invalid data sent.');
      return;
    }
    
    if (!proc) {
      socket.emit('stderr', 'bin-wrapper: Pipe has been unexpectedly closed.');
      return;
    }
    
    proc.stdin.write(data);
  });
});
server.listen(8081);